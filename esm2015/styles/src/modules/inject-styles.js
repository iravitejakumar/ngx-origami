import { APP_INITIALIZER, ComponentFactoryResolver, NgModuleRef, RendererFactory2, ViewEncapsulation } from '@angular/core';
import { Router } from '@angular/router';
import { stylesFromModule } from '@polymer/polymer/lib/utils/style-gather';
import { whenSet } from 'ngx-origami/util';
import { getStyleModulesFor } from './include-styles';
import { styleToEmulatedEncapsulation } from './style-to-emulated-encapsulation';
import { getTypeFor, scanComponentFactoryResolver } from './type-selectors';
/**
 * Provider that ensures `injectIncludeStyles()` will run on application
 * startup before components are created.
 */
export const INJECT_STYLES_PROVIDER = {
    provide: APP_INITIALIZER,
    multi: true,
    useFactory: injectIncludeStyles,
    deps: [NgModuleRef]
};
/**
 * Provider that ensures `injectIncludeStyles()` will run on application
 * startup before components are created. This provider does _not_ require
 * @angular/router.
 */
export const INJECT_STYLES_NO_ROUTER_PROVIDER = {
    provide: APP_INITIALIZER,
    multi: true,
    useFactory: injectIncludeStylesNoRouter,
    deps: [NgModuleRef]
};
/**
 * Returns a callback that, when invoked, will use the provided `NgModuleRef`
 * to patch the renderer factory and scan the component factory resolver in
 * order to enable injecting Polymer style modules for components decorated with
 * `@IncludeStyles()`.
 *
 * This function will additionally listen to any lazy-loaded modules from
 * Angular's router and scan component factory resolvers that are added after
 * the app has initialized.
 *
 * @param ngModule the root `NgModule` reference
 * @returns a callback that will begin the injection process
 */
export function injectIncludeStyles(ngModule) {
    const injectStyles = injectIncludeStylesNoRouter(ngModule);
    return () => {
        injectStyles();
        const router = ngModule.injector.get(Router);
        router.events.subscribe(e => {
            if ('route' in e && !e.route._loadedConfig) {
                whenSet(e.route, '_loadedConfig', undefined, config => {
                    scanComponentFactoryResolver(config.module.injector.get(ComponentFactoryResolver));
                });
            }
        });
    };
}
/**
 * Returns a callback that, when invoked, will use the provided `NgModuleRef`
 * to patch the renderer factory and scan the component factory resolver in
 * order to enable injecting Polymer style modules for components decorated with
 * `@IncludeStyles()`.
 *
 * @param ngModule the root `NgModule` reference
 * @returns a callback that will begin the injection process
 */
export function injectIncludeStylesNoRouter(ngModule) {
    return () => {
        patchRendererFactory(ngModule.injector.get(RendererFactory2));
        scanComponentFactoryResolver(ngModule.injector.get(ComponentFactoryResolver));
    };
}
const INJECTED_SELECTORS = [];
/**
 * Patches a `RendererFactory2` to overwrite `createRenderer()` and add styles
 * imported from Polymer style modules according to `@IncludeStyles()`
 * decorators to the `RendererType2` data for the element.
 *
 * If the element type using emulated view encapsulation, the styles imported
 * will be converted to preserve encapsulation.
 *
 * @param factory the renderer factory to patch
 */
export function patchRendererFactory(factory) {
    const $createRenderer = factory.createRenderer;
    factory.createRenderer = function (element, type) {
        const selector = element && element.localName;
        if (selector && type && INJECTED_SELECTORS.indexOf(selector) === -1) {
            const styleModules = getStyleModulesFor(getTypeFor(selector));
            let styles = styleModules.map(styleModule => {
                const styleElements = stylesFromModule(styleModule);
                return styleElements.map(e => e.innerText).join('\n');
            });
            switch (type.encapsulation) {
                case ViewEncapsulation.Emulated:
                default:
                    styles = styles.map(style => styleToEmulatedEncapsulation(style));
                    break;
                case ViewEncapsulation.None:
                case ViewEncapsulation.Native:
                case ViewEncapsulation.ShadowDom:
                    break;
            }
            type.styles.push(...styles);
            INJECTED_SELECTORS.push(selector);
        }
        return $createRenderer.apply(this, arguments);
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0LXN0eWxlcy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1vcmlnYW1pL3N0eWxlcy8iLCJzb3VyY2VzIjpbInNyYy9tb2R1bGVzL2luamVjdC1zdHlsZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGVBQWUsRUFDZix3QkFBd0IsRUFDeEIsV0FBVyxFQUVYLGdCQUFnQixFQUNoQixpQkFBaUIsRUFDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNqRixPQUFPLEVBQUUsVUFBVSxFQUFFLDRCQUE0QixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFNUU7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sc0JBQXNCLEdBQWE7SUFDOUMsT0FBTyxFQUFFLGVBQWU7SUFDeEIsS0FBSyxFQUFFLElBQUk7SUFDWCxVQUFVLEVBQUUsbUJBQW1CO0lBQy9CLElBQUksRUFBRSxDQUFDLFdBQVcsQ0FBQztDQUNwQixDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLGdDQUFnQyxHQUFhO0lBQ3hELE9BQU8sRUFBRSxlQUFlO0lBQ3hCLEtBQUssRUFBRSxJQUFJO0lBQ1gsVUFBVSxFQUFFLDJCQUEyQjtJQUN2QyxJQUFJLEVBQUUsQ0FBQyxXQUFXLENBQUM7Q0FDcEIsQ0FBQztBQUVGOzs7Ozs7Ozs7Ozs7R0FZRztBQUNILE1BQU0sVUFBVSxtQkFBbUIsQ0FBQyxRQUEwQjtJQUM1RCxNQUFNLFlBQVksR0FBRywyQkFBMkIsQ0FBQyxR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UF9JTklUSUFMSVpFUixcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBOZ01vZHVsZVJlZixcbiAgUHJvdmlkZXIsXG4gIFJlbmRlcmVyRmFjdG9yeTIsXG4gIFZpZXdFbmNhcHN1bGF0aW9uXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IHN0eWxlc0Zyb21Nb2R1bGUgfSBmcm9tICdAcG9seW1lci9wb2x5bWVyL2xpYi91dGlscy9zdHlsZS1nYXRoZXInO1xuaW1wb3J0IHsgd2hlblNldCB9IGZyb20gJ25neC1vcmlnYW1pL3V0aWwnO1xuaW1wb3J0IHsgZ2V0U3R5bGVNb2R1bGVzRm9yIH0gZnJvbSAnLi9pbmNsdWRlLXN0eWxlcyc7XG5pbXBvcnQgeyBzdHlsZVRvRW11bGF0ZWRFbmNhcHN1bGF0aW9uIH0gZnJvbSAnLi9zdHlsZS10by1lbXVsYXRlZC1lbmNhcHN1bGF0aW9uJztcbmltcG9ydCB7IGdldFR5cGVGb3IsIHNjYW5Db21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfSBmcm9tICcuL3R5cGUtc2VsZWN0b3JzJztcblxuLyoqXG4gKiBQcm92aWRlciB0aGF0IGVuc3VyZXMgYGluamVjdEluY2x1ZGVTdHlsZXMoKWAgd2lsbCBydW4gb24gYXBwbGljYXRpb25cbiAqIHN0YXJ0dXAgYmVmb3JlIGNvbXBvbmVudHMgYXJlIGNyZWF0ZWQuXG4gKi9cbmV4cG9ydCBjb25zdCBJTkpFQ1RfU1RZTEVTX1BST1ZJREVSOiBQcm92aWRlciA9IHtcbiAgcHJvdmlkZTogQVBQX0lOSVRJQUxJWkVSLFxuICBtdWx0aTogdHJ1ZSxcbiAgdXNlRmFjdG9yeTogaW5qZWN0SW5jbHVkZVN0eWxlcyxcbiAgZGVwczogW05nTW9kdWxlUmVmXVxufTtcblxuLyoqXG4gKiBQcm92aWRlciB0aGF0IGVuc3VyZXMgYGluamVjdEluY2x1ZGVTdHlsZXMoKWAgd2lsbCBydW4gb24gYXBwbGljYXRpb25cbiAqIHN0YXJ0dXAgYmVmb3JlIGNvbXBvbmVudHMgYXJlIGNyZWF0ZWQuIFRoaXMgcHJvdmlkZXIgZG9lcyBfbm90XyByZXF1aXJlXG4gKiBAYW5ndWxhci9yb3V0ZXIuXG4gKi9cbmV4cG9ydCBjb25zdCBJTkpFQ1RfU1RZTEVTX05PX1JPVVRFUl9QUk9WSURFUjogUHJvdmlkZXIgPSB7XG4gIHByb3ZpZGU6IEFQUF9JTklUSUFMSVpFUixcbiAgbXVsdGk6IHRydWUsXG4gIHVzZUZhY3Rvcnk6IGluamVjdEluY2x1ZGVTdHlsZXNOb1JvdXRlcixcbiAgZGVwczogW05nTW9kdWxlUmVmXVxufTtcblxuLyoqXG4gKiBSZXR1cm5zIGEgY2FsbGJhY2sgdGhhdCwgd2hlbiBpbnZva2VkLCB3aWxsIHVzZSB0aGUgcHJvdmlkZWQgYE5nTW9kdWxlUmVmYFxuICogdG8gcGF0Y2ggdGhlIHJlbmRlcmVyIGZhY3RvcnkgYW5kIHNjYW4gdGhlIGNvbXBvbmVudCBmYWN0b3J5IHJlc29sdmVyIGluXG4gKiBvcmRlciB0byBlbmFibGUgaW5qZWN0aW5nIFBvbHltZXIgc3R5bGUgbW9kdWxlcyBmb3IgY29tcG9uZW50cyBkZWNvcmF0ZWQgd2l0aFxuICogYEBJbmNsdWRlU3R5bGVzKClgLlxuICpcbiAqIFRoaXMgZnVuY3Rpb24gd2lsbCBhZGRpdGlvbmFsbHkgbGlzdGVuIHRvIGFueSBsYXp5LWxvYWRlZCBtb2R1bGVzIGZyb21cbiAqIEFuZ3VsYXIncyByb3V0ZXIgYW5kIHNjYW4gY29tcG9uZW50IGZhY3RvcnkgcmVzb2x2ZXJzIHRoYXQgYXJlIGFkZGVkIGFmdGVyXG4gKiB0aGUgYXBwIGhhcyBpbml0aWFsaXplZC5cbiAqXG4gKiBAcGFyYW0gbmdNb2R1bGUgdGhlIHJvb3QgYE5nTW9kdWxlYCByZWZlcmVuY2VcbiAqIEByZXR1cm5zIGEgY2FsbGJhY2sgdGhhdCB3aWxsIGJlZ2luIHRoZSBpbmplY3Rpb24gcHJvY2Vzc1xuICovXG5leHBvcnQgZnVuY3Rpb24gaW5qZWN0SW5jbHVkZVN0eWxlcyhuZ01vZHVsZTogTmdNb2R1bGVSZWY8YW55Pik6ICgpID0+IHZvaWQge1xuICBjb25zdCBpbmplY3RTdHlsZXMgPSBpbmplY3RJbmNsdWRlU3R5bGVzTm9Sb3V0ZXIobmdNb2R1bGUpO1xuICByZXR1cm4gKCkgPT4ge1xuICAgIGluamVjdFN0eWxlcygpO1xuICAgIGNvbnN0IHJvdXRlciA9IDxSb3V0ZXI+bmdNb2R1bGUuaW5qZWN0b3IuZ2V0KFJvdXRlcik7XG4gICAgcm91dGVyLmV2ZW50cy5zdWJzY3JpYmUoZSA9PiB7XG4gICAgICBpZiAoJ3JvdXRlJyBpbiBlICYmICEoPGFueT5lLnJvdXRlKS5fbG9hZGVkQ29uZmlnKSB7XG4gICAgICAgIHdoZW5TZXQoPGFueT5lLnJvdXRlLCAnX2xvYWRlZENvbmZpZycsIHVuZGVmaW5lZCwgY29uZmlnID0+IHtcbiAgICAgICAgICBzY2FuQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKFxuICAgICAgICAgICAgY29uZmlnLm1vZHVsZS5pbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKVxuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9O1xufVxuXG4vKipcbiAqIFJldHVybnMgYSBjYWxsYmFjayB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgdXNlIHRoZSBwcm92aWRlZCBgTmdNb2R1bGVSZWZgXG4gKiB0byBwYXRjaCB0aGUgcmVuZGVyZXIgZmFjdG9yeSBhbmQgc2NhbiB0aGUgY29tcG9uZW50IGZhY3RvcnkgcmVzb2x2ZXIgaW5cbiAqIG9yZGVyIHRvIGVuYWJsZSBpbmplY3RpbmcgUG9seW1lciBzdHlsZSBtb2R1bGVzIGZvciBjb21wb25lbnRzIGRlY29yYXRlZCB3aXRoXG4gKiBgQEluY2x1ZGVTdHlsZXMoKWAuXG4gKlxuICogQHBhcmFtIG5nTW9kdWxlIHRoZSByb290IGBOZ01vZHVsZWAgcmVmZXJlbmNlXG4gKiBAcmV0dXJucyBhIGNhbGxiYWNrIHRoYXQgd2lsbCBiZWdpbiB0aGUgaW5qZWN0aW9uIHByb2Nlc3NcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdEluY2x1ZGVTdHlsZXNOb1JvdXRlcihcbiAgbmdNb2R1bGU6IE5nTW9kdWxlUmVmPGFueT5cbik6ICgpID0+IHZvaWQge1xuICByZXR1cm4gKCkgPT4ge1xuICAgIHBhdGNoUmVuZGVyZXJGYWN0b3J5KG5nTW9kdWxlLmluamVjdG9yLmdldChSZW5kZXJlckZhY3RvcnkyKSk7XG4gICAgc2NhbkNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcihcbiAgICAgIG5nTW9kdWxlLmluamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpXG4gICAgKTtcbiAgfTtcbn1cblxuY29uc3QgSU5KRUNURURfU0VMRUNUT1JTOiBzdHJpbmdbXSA9IFtdO1xuXG4vKipcbiAqIFBhdGNoZXMgYSBgUmVuZGVyZXJGYWN0b3J5MmAgdG8gb3ZlcndyaXRlIGBjcmVhdGVSZW5kZXJlcigpYCBhbmQgYWRkIHN0eWxlc1xuICogaW1wb3J0ZWQgZnJvbSBQb2x5bWVyIHN0eWxlIG1vZHVsZXMgYWNjb3JkaW5nIHRvIGBASW5jbHVkZVN0eWxlcygpYFxuICogZGVjb3JhdG9ycyB0byB0aGUgYFJlbmRlcmVyVHlwZTJgIGRhdGEgZm9yIHRoZSBlbGVtZW50LlxuICpcbiAqIElmIHRoZSBlbGVtZW50IHR5cGUgdXNpbmcgZW11bGF0ZWQgdmlldyBlbmNhcHN1bGF0aW9uLCB0aGUgc3R5bGVzIGltcG9ydGVkXG4gKiB3aWxsIGJlIGNvbnZlcnRlZCB0byBwcmVzZXJ2ZSBlbmNhcHN1bGF0aW9uLlxuICpcbiAqIEBwYXJhbSBmYWN0b3J5IHRoZSByZW5kZXJlciBmYWN0b3J5IHRvIHBhdGNoXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXRjaFJlbmRlcmVyRmFjdG9yeShmYWN0b3J5OiBSZW5kZXJlckZhY3RvcnkyKSB7XG4gIGNvbnN0ICRjcmVhdGVSZW5kZXJlciA9IGZhY3RvcnkuY3JlYXRlUmVuZGVyZXI7XG4gIGZhY3RvcnkuY3JlYXRlUmVuZGVyZXIgPSBmdW5jdGlvbihlbGVtZW50LCB0eXBlKSB7XG4gICAgY29uc3Qgc2VsZWN0b3IgPSBlbGVtZW50ICYmIGVsZW1lbnQubG9jYWxOYW1lO1xuICAgIGlmIChzZWxlY3RvciAmJiB0eXBlICYmIElOSkVDVEVEX1NFTEVDVE9SUy5pbmRleE9mKHNlbGVjdG9yKSA9PT0gLTEpIHtcbiAgICAgIGNvbnN0IHN0eWxlTW9kdWxlcyA9IGdldFN0eWxlTW9kdWxlc0ZvcihnZXRUeXBlRm9yKHNlbGVjdG9yKSk7XG4gICAgICBsZXQgc3R5bGVzID0gc3R5bGVNb2R1bGVzLm1hcChzdHlsZU1vZHVsZSA9PiB7XG4gICAgICAgIGNvbnN0IHN0eWxlRWxlbWVudHMgPSBzdHlsZXNGcm9tTW9kdWxlKHN0eWxlTW9kdWxlKTtcbiAgICAgICAgcmV0dXJuIHN0eWxlRWxlbWVudHMubWFwKGUgPT4gZS5pbm5lclRleHQpLmpvaW4oJ1xcbicpO1xuICAgICAgfSk7XG4gICAgICBzd2l0Y2ggKHR5cGUuZW5jYXBzdWxhdGlvbikge1xuICAgICAgICBjYXNlIFZpZXdFbmNhcHN1bGF0aW9uLkVtdWxhdGVkOlxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHN0eWxlcyA9IHN0eWxlcy5tYXAoc3R5bGUgPT4gc3R5bGVUb0VtdWxhdGVkRW5jYXBzdWxhdGlvbihzdHlsZSkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFZpZXdFbmNhcHN1bGF0aW9uLk5vbmU6XG4gICAgICAgIGNhc2UgVmlld0VuY2Fwc3VsYXRpb24uTmF0aXZlOlxuICAgICAgICBjYXNlIFZpZXdFbmNhcHN1bGF0aW9uLlNoYWRvd0RvbTpcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgdHlwZS5zdHlsZXMucHVzaCguLi5zdHlsZXMpO1xuICAgICAgSU5KRUNURURfU0VMRUNUT1JTLnB1c2goc2VsZWN0b3IpO1xuICAgIH1cblxuICAgIHJldHVybiAkY3JlYXRlUmVuZGVyZXIuYXBwbHkodGhpcywgPGFueT5hcmd1bWVudHMpO1xuICB9O1xufVxuIl19